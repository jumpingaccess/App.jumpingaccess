<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <%= csrf_meta_tags %>
  <%= javascript_importmap_tags %>
  <%= javascript_include_tag "import_modal", defer: true %>
  <%= javascript_include_tag "castr_controller", defer: true %>
  <%= javascript_include_tag "startlist_controller", defer: true %>
  <%= javascript_include_tag "results_controller", defer: true %>
  <!-- ‚úÖ Bootstrap + FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <!-- ‚úÖ Custom CSS -->
  <%= stylesheet_link_tag "/css/custom.css?v=#{Time.now.to_i}", media: "all" %>
  <!-- Castr.IO Key -->
  <% if current_user&.role == "admin" &&
        (castr_api_key = ApiCredential.find_by("LOWER(name) LIKE ?", "%castr%")&.api_key) %>
    <meta name="castr-api-key" content="<%= castr_api_key %>">
  <% end %>
</head>

<body class="d-flex">
<!-- ‚úÖ Sidebar -->

<aside class="sidebar d-flex flex-column p-3 align-items-center">
  <!-- Logo centr√© et plus grand -->
  <a href="/admin/dashboard" class="text-white text-decoration-none text-center w-100">
    <img src="/logo.png" alt="Logo" class="img-fluid" style="max-height: 64px;">
  </a>
  <div class="sidebar">
    <ul class="nav flex-column sidebar-nav py-3">

      <% if request.path.start_with?("/admin/meetings/") %>
        <li class="nav-item mb-1">


          <% if defined?(@meeting) && @meeting.present? %>
            <%= link_to videos_admin_meeting_path(@meeting), class: "sidebar-link #{'active' if request.path.include?('videos')}" do %>
              <i class="fas fa-video fa-lg mb-3"></i>
              <small>Vid√©os</small>
            <% end %>
          <% end %>

        </li>
        <li class="nav-item mb-1">
          <%= link_to "#", class: "sidebar-link #{'active' if request.path.include?('clipvideo')}" do %>
            <i class="fas fa-scissors fa-lg mb-3"></i>
            <small>Clipping</small>
          <% end %>
        </li>
        <li class="nav-item mb-1">
          <%= link_to "#", class: "sidebar-link #{'active' if request.path.include?('customisation')}" do %>
            <i class="fas fa-sliders-h fa-lg mb-3"></i>
            <small>Customisation</small>
          <% end %>
        </li>

        <li class="nav-item mb-1">
          <%= link_to "#", class: "sidebar-link #{'active' if request.path.include?('media')}" do %>
            <i class="fas fa-photo-video fa-lg mb-3"></i>
            <small>Media</small>
          <% end %>
        </li>
        <%= link_to antmedia_admin_meeting_path(@meeting), class: "sidebar-link" do %>
          <i class="fas fa-network-wired fa-lg mb-3"></i>
          <small>Streams</small>
        <% end %>

        <li class="nav-item mb-1">
          <%= link_to "#", class: "sidebar-link #{'active' if request.path.include?('s3')}" do %>
            <i class="fas fa-cloud fa-lg mb-3"></i>
            <small>AWS S3</small>
          <% end %>
        </li>
      <% end %>
    </ul>

  </div>


</aside>

<!-- ‚úÖ Main content -->
<div class="flex-grow-1 d-flex flex-column">
  <header class="topbar px-4 py-2 d-flex justify-content-between align-items-center">

    <!-- üü© Zone gauche : Menu Fichier -->
    <div class="d-flex align-items-center gap-3">
      <% if request.path.start_with?("/admin/dashboard") %>
        <!-- ‚úÖ Menu Fichier -->
        <div class="dropdown">
          <button class="btn btn-sm text-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Fichier
          </button>
          <ul class="dropdown-menu">
            <li>
              <%= link_to new_competition_path, class: "dropdown-item" do %>
                Nouveau meeting

              <% end %>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <%= link_to admin_import_equipe_path, class: "dropdown-item" do %>
                <i class="fa-solid fa-download me-2"></i>Importer depuis Equipe
              <% end %>
            </li>

            <li>
              <%= link_to import_hippo_path, class: "dropdown-item " do %>
                <i class="fa-solid fa-download me-2"></i>Importer depuis Hippodata

              <% end %>
            </li>

          </ul>
        </div>

      <% elsif request.path.start_with?("/admin/meetings/") %>
        <!-- ‚úÖ Autre menu sp√©cifique au meeting -->
        <div class="dropdown">
          <button class="btn btn-sm text-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Importer
          </button>
          <ul class="dropdown-menu">


            <% if @meeting&.provider == "equipe" %>

              <li>
                <a href="<%= admin_meeting_classimport_path(@meeting&.id) %>"
                   data-controller="import"
                   data-action="click->import#start"
                   data-import-url="<%= admin_meeting_classimport_path(@meeting&.id) %>"
                   class="dropdown-item">
                  <i class="fa-solid fa-download me-2"></i>Importer depuis Equipe
                </a>
              </li>
              <li>
                <a href="<%= admin_meeting_horseimport_path(@meeting&.id) %>"
                   data-controller="import"
                   data-action="click->import#start"
                   data-import-url="<%= admin_meeting_horseimport_path(@meeting&.id) %>"
                   class="dropdown-item">
                  <i class="fa-solid fa-download me-2"></i>Chevaux depuis Equipe
                </a>
              </li>

            <% elsif @meeting&.provider == "hippodata" %>
              <li>
                <a href="#"
                   class="dropdown-item disabled">
                  <i class="fa-solid fa-download me-2"></i> √âpreuves depuis Hippodata
                </a>
              </li>
              <li>
                <a href="#"
                   class="dropdown-item disabled">
                  <i class="fa-solid fa-download me-2"></i> Chevaux depuis Hippodata
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <div class="dropdown">
        <button class="btn btn-sm text-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fa-solid fa-chart-line me-1"></i>
          Monitoring
        </button>
        <ul class="dropdown-menu">
          <li>
            <%= link_to admin_monitoring_index_path, class: "dropdown-item" do %>
              <i class="fa-solid fa-tachometer-alt me-2"></i>Vue d'ensemble
            <% end %>
          </li>
          <li>
            <%= link_to admin_monitoring_rabbitmq_path, class: "dropdown-item" do %>
              <i class="fa-solid fa-server me-2"></i>RabbitMQ
            <% end %>
          </li>
          <li>
            <%= link_to admin_monitoring_nodejs_path, class: "dropdown-item" do %>
              <i class="fa-brands fa-node-js me-2"></i>Node.js Consumer
            <% end %>
          </li>
          <li>
            <%= link_to admin_monitoring_competitions_path, class: "dropdown-item" do %>
              <i class="fa-solid fa-trophy me-2"></i>Comp√©titions
            <% end %>
          </li>
        </ul>
      </div>

    </div>


    <!-- üü¶ Zone centrale : champ de recherche -->
    <div class="flex-grow-1 px-4 d-flex justify-content-center">
      <div class="position-relative w-100" style="max-width: 800px;">
        <div class="input-group input-group-sm bg-transparent">
              <span class="input-group-text bg-transparent border-0 text-white">
                <i class="fas fa-search"></i>
              </span>
          <input type="text"
                 id="competition-search"
                 class="form-control text-white border-0 shadow-none"
                 placeholder="Rechercher Concours"
                 autocomplete="off">
        </div>
        <div id="competition-results"
             class="position-absolute w-100 mt-1 d-none rounded shadow-sm z-3"></div>
      </div>
    </div>
    <!-- üü• Zone droite : configuration & profil -->
    <div class="d-flex align-items-center gap-3">
      <% if current_user&.role == "admin" %>
        <div class="dropdown">
          <button class="btn btn-sm text-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-cog"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><%= link_to "Liste des utilisateurs", users_path, class: "dropdown-item" %></li>
            <li><%= link_to raw('<i class="fas fa-key me-2"></i> Cl√©s API & Endpoints'), admin_api_credentials_path, class: "dropdown-item " %></li>
          </ul>
        </div>
      <% end %>

      <% if current_user %>
        <div class="dropdown">
          <button class="btn btn-sm text-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li class="dropdown-header"><strong><%= current_user.email %></strong></li>
            <li><%= link_to "Mon profil", edit_user_path(current_user), class: "dropdown-item" %></li>
            <li><%= link_to "D√©connexion", logout_path, method: :delete, data: { turbo: false }, class: "dropdown-item" %></li>
          </ul>
        </div>
      <% end %>
    </div>
  </header>


  <!-- Main body -->
  <main class="p-4 bg-light flex-grow-1 overflow-auto">
    <% if flash[:notice] %>
      <div class="alert alert-success alert-dismissible fade show auto-dismiss" role="alert">
        <%= flash[:notice] %>
      </div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert alert-danger alert-dismissible fade show auto-dismiss" role="alert">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <%= yield %>
  </main>
</div>

<div class="modal fade" id="importProgressModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p class="mb-3">Import en cours...</p>
        <div class="progress">
          <div id="importProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
    document.addEventListener("turbo:load", function () {
        const input = document.getElementById("competition-search");
        if (!input) return;

        const results = document.getElementById("competition-results");
        let timeout = null;
        let selectedIndex = -1;
        let lastQueryId = 0;

        input.addEventListener("input", function () {
            clearTimeout(timeout);
            const query = input.value.trim();

            if (query.length < 2) {
                results.innerHTML = "";
                results.classList.add("d-none");
                return;
            }

            timeout = setTimeout(() => {
                const currentQueryId = ++lastQueryId;
                fetch(`/admin/competitions/autocomplete?q=${encodeURIComponent(query)}`)
                    .then(response => response.text())
                    .then(html => {
                        if (currentQueryId !== lastQueryId) return;
                        results.innerHTML = html;
                        results.classList.remove("d-none");
                        selectedIndex = -1;
                    });
            }, 200);
        });

        input.addEventListener("keydown", function (e) {
            const items = results.querySelectorAll(".autocomplete-item");
            if (!items.length) return;

            if (e.key === "ArrowDown") {
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection(items);
                e.preventDefault();
            } else if (e.key === "ArrowUp") {
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection(items);
                e.preventDefault();
            } else if (e.key === "Enter") {
                if (selectedIndex >= 0) {
                    items[selectedIndex].click();
                    e.preventDefault();
                }
            }
        });

        function updateSelection(items) {
            items.forEach((el, idx) => {
                el.classList.toggle("active", idx === selectedIndex);
            });
        }

        document.addEventListener("click", function (e) {
            if (!input.contains(e.target) && !results.contains(e.target)) {
                results.classList.add("d-none");
            }
        });

        results.addEventListener("click", function (e) {
            const item = e.target.closest(".autocomplete-item");
            if (item) {
                window.location.href = item.dataset.url;
            }
        });
    });


    document.addEventListener("turbo:load", function () {
        setTimeout(function () {
            document.querySelectorAll('.alert-dismissible').forEach(function (el) {
                // Ajoute la classe Bootstrap fade out
                el.classList.remove('show');
                el.classList.add('fade');
                // Puis supprime compl√®tement du DOM apr√®s animation (300ms)
                setTimeout(() => el.remove(), 300);
            });
        }, 3000); // 3 secondes
    });
</script>


</body>
</html>
